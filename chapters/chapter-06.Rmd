# Building propensity score models

Often we are interested in assessing how some *exposure* (or treatment) impacts an outcome. For example, we could assess how an ad campaign (exposure) impacts sales (outcome), whether a certain medication (exposure) improves patient survival (outcome), or whether opening a theme park early to some visitors (exposure) reduces wait times later in the day (outcome). As defined in the previous chapter, an exposure in the context of this book is an often modifiable event or condition that occurs prior to the outcome. In randomized trials, participants are randomly assigned to exposure groups. If all goes well, this allows for an unbiased estimate of the causal effect between the exposure and outcome. In the "real world", outside this randomized trial setting, we are often placed in *exposure* groups based on other factors. For example, when deciding what medication to give a diabetic patient, a doctor may consider the patient's medical history, their likelihood to adhere to certain medications, and the severity of their disease. The medication they are given is no longer random, it is *conditional* on factors about that patient, also known as the patient's *covariates*. If we could could collect information about all of these factors, we could determine each patient's probability of exposure and use this to inform an analysis assessing the relationship between that exposure and some outcome. This is the propensity score! When fitting a *propensity score model* we want to condition on all known confounders.

:::def-box
A **propensity score** is the probability of being in the exposure group, conditioned on observed covariates.
:::

@rosenbaum1983central showed in observational studies, conditioning on propensity scores can lead to unbiased estimates of the exposure effect as long as certain assumptions hold:

1. There are no unmeasured confounders
2. Every subject has a nonzero probability of receiving either exposure

## Logistic Regression

There are many ways to estimate the propensity score; typically people use logistic regression. This is done by fitting a logistic regression model predicting the exposure using known covariates. Each individuals' predicted values are the propensity scores. In R, a logistic regression model can be fit using the `glm()` function. Below is pseudo-code. The first argument is the model, with the exposure on the left side and the confounders on the right. The data frame is passed to the `data` argument and the `family = binomial()` argument to denote the model should be fit using logistic regression (as opposed to a different generalized linear model).

```{r, eval = FALSE}
glm(
  exposure ~ confounder_1 + confounder_2, 
  data = df,
  family = binomial()
)
```

We can extract the propensity scores by pulling out the predictions on the probability scale. Using the `augment()` function from the broom package, we can extract these propensity scores and add them to our original data frame. The argument `type.predict` is set to `"response"` to indicate that we want to extract the predicted values on the *probability* scale. By default, these will be on the linear logit scale. The `data` argument contains the original data frame. This code will output a new data frame consisting of all components in `df` with six additional columns corresponding to the logistic regression model that was fit. The `.fitted` column is the propensity score.

```{r, eval = FALSE}
glm(
  exposure ~ confounder_1 + confounder_2, 
  data = df,
  family = binomial()
) %>%
  augment(type.predict = "response", data = df)
```

Let's look at an example. 

### Example

Historically, guests who stayed in a Walt Disney World resort hotel were able to access the park during "Extra Magic Hours" during which the park was closed to all other guests. These extra hours could be in the morning or evening. In 2018, there were four theme parks that provided "Extra Magic Hours" at Disney World: Magic Kingdom Park, EPCOT, Disney's Hollywood Studios, and Disney's Animal Kingdom Park. Typically, each day one park was selected to have these "Extra Magic Hours". We are interested in examining the relationship between whether a park had "Extra Magic Hours" in the morning and the average wait time for attractions the same day between 5pm and 6pm. Below is a proposed DAG for this question.

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Proposed DAG for the relationship between Extra Magic Hours in the morning at a particular park and the average wait time between 5pm and 6pm."}
library(ggdag)

coord_dag <- list(
  x = c(Park = 0, Season = 0, close = 0, avg = 0, x = 1, y = 2),
  y = c(Park = -1, avg = -0.25, Season = 1, close = 0.25, x = 0, y = 0)
)

labels <- c(
  x = "Extra Magic Morning",
  y = "Average wait between 5pm and 6pm",
  Park = "Park",
  Season = "Ticket Season",
  close = "Time park closed",
  avg = "Average wait per 100 guests in line"
)

dagify(
  y ~ x,
  y ~ close,
  y ~ Park,
  y ~ Season,
  y ~ avg,
  x ~ avg,
  x ~ Park,
  x ~ close,
  x ~ Season,
  coords = coord_dag,
  labels = labels
) %>%
  ggdag(use_labels = "label", text = FALSE) + 
  theme_void()
```

Here we are proposing that there are four confounders, the park where the attraction is located, the time the park closed, the ticket season: value, regular, or peak, and the average wait per 100 guests in line for the attraction. We can build a propensity score model using the `touringplans_2018` data set from the touringplans package. Each row of this dataset contains information about a particular attraction during a certain hour on a given day. First we need to subset the data to only include average wait times between 5 and 6 pm. Then we will use the `glm()` function to fit the propensity score model, predicting `extra_magic_morning` using the four confounders specified above. We'll add the propensity scores to the data frame (in a column called `.fitted` as set by the `augment()` function in the broom package).

```{r}
library(tidyverse)
library(broom)
library(touringplans)

df <- touringplans_2018 %>%
  filter(hour == 17)

glm(
  extra_magic_morning ~ park + wdw_ticket_season + close + average_wait_per_hundred,
  data = df,
  family = binomial()
) %>% 
  augment(type.predict = "response", data = df) -> df
```

Let's take a look at these propensity scores. Below, the propensity scores are shown in the `.fitted` column for the first 10 observations. The propensity score here is the probability that a given date will have Extra Magic Hours in the morning given the observed covariates, in this case Park and Ticket Season. For example, on June 30, 2018 there was a 58.8\% chance that there would be Extra Magic Hours for the Alien Swirling Saucers given this attraction is located at Disney's Hollywood Studios, the Ticket Season (peak in this case), time of park closure (11pm), and the average wait per 100 guests in line (10 minutes). On this particular day, there were *not* Extra Magic Hours in the morning (as indicated by the 0 in the first row of the `extra_magic_morning` column). 

```{r}
df %>%
  select(date, name, extra_magic_morning, park, wdw_ticket_season, close, average_wait_per_hundred, .fitted)
```
We can examine the distribution of propensity scores by exposure group. A nice way to visualize this is via "mirrored histograms". The code below creates two histograms of the propensity scores, one on the "top" for the exposed group (the dates with Extra Magic Hours in the morning) and one on the "bottom" for the unexposed group. Because we only have two variables

```{r}
ggplot() +
  geom_histogram(data = df %>% filter(extra_magic_morning == 1), 
                 aes(x = .fitted),
                 fill = "orange", 
                 bins = 25) + 
  geom_histogram(data = df %>% filter(extra_magic_morning == 0), 
                 aes(x = .fitted, 
                     y = -..count..), 
                 fill = "cornflower blue",
                 bins = 25) +
  scale_y_continuous("Count", label = abs) + 
  scale_x_continuous("Propensity Score")
```
In the code above, the first `geom_histogram()` call creates the top histogram by subsetting the `df` data frame to only include those in the exposure group, where `extra_magic_morning == 1`. The x-axis for the histogram is the propensity score, which lives in the `.fitted` column of the data frame. The second `geom_histogram()` call creates the bottom histogram, subsetting to only those in the unexposed group. Here, we use the `y` argument to *flip* the histogram by setting this to `-..count..`. `..count..` is a keyword that ggplot2 recognizes as the frequency counts for the histogram. Finally, we need to edit the y-axis to show the absolute value (rather than negative values below 0) so the correct numbers are displayed; this is accomplished by setting `label = abs` in the `scale_y_continuous()` function. 

## Choosing what variables to include

## Continuous exposures


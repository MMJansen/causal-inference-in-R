---
bibliography: ../citations.bib
---

# Whole Game: Mosquito Nets and Malaria

```{r, include=FALSE}
# TODO: remove in favor of DESCRIPTION file
lapply(c('propensity', 'halfmoon'), function(pkg) {
  if (system.file(package = pkg) == '') remotes::install_github(paste0("malcolmbarrett/", pkg))
})
```

In this chapter, we'll analyze data using some of the techniques we'll learn in this book.
We'll play the [whole game](https://www.gse.harvard.edu/news/uk/09/01/education-bat-seven-principles-educators) of causal analysis using a few key steps:

1.  Specify a causal question
2.  Draw our assumptions using a causal diagram
3.  Model our assumptions
4.  Diagnose our models
5.  Estimate the causal effect
6.  Conduct sensitivity analysis on the effect estimate

In this guided exercise, we'll attempt to answer a causal question: does using a bed net reduce risk of malaria?

Malaria remains a serious public health issue.
Additionally, while incidence of malaria has decreased since 2000, 2020 and the COVID-19 pandemic saw an increase in cases and deaths due primarily to service interruption [@worldma].
About 86% of malaria deaths occurred in 29 countries, but about half of all malaria deaths occurred in just six countries: Nigeria (27%), the Democratic Republic of the Congo (12%), Uganda (5%), Mozambique (4%), Angola (3%) and Burkina Faso (3%).
Most of these deaths occurred in children under 5 [@mosquito] .
Malaria also poses severe health risks to pregnant women and worsens birth outcomes, including early delivery and low birth weight.

Bed nets prevent morbidity and mortality due to malaria by providing a barrier against infective bites by the chief host of malaria parasites, the mosquito.
Bed nets have been used since ancient times.
Herodotus, the 5th century BC Greek author of *The Histories*, observed Egyptians using their fishing nets as bed nets:

> Against the gnats, which are very abundant, they have contrived as follows:---those who dwell above the fen-land are helped by the towers, to which they ascend when they go to rest; for the gnats by reason of the winds are not able to fly up high: but those who dwell in the fen-land have contrived another way instead of the towers, and this is it:---every man of them has got a casting net, with which by day he catches fish, but in the night he uses it for this purpose, that is to say he puts the casting-net round about the bed in which he sleeps, and then creeps in under it and goes to sleep: and the gnats, if he sleeps rolled up in a garment or a linen sheet, bite through these, but through the net they do not even attempt to bite [@thehist].

Many modern nets are also treated with insecticide, dating back to Russian soldiers in World War II [@nevill1996], although they have still been known to be used as fishing nets [@gettleman2015].

It's easy to imagine a randomized trial that deals with this question: participants in a study are randomly assigned to using a bed net, and we follow them over time to see if there is a difference in malaria risk between groups.
Randomization is often the best way to estimate a causal effect of an intervention because it reduces the number of assumptions we need to make for that estimate to be valid (we'll discuss the assumptions we need to make for causal inference in Chapter \@ref(TODO)).
In particular, randomization addresses confounding very well, accounting for confounders we may not even know about.

In fact, there have been several landmark trials studying the effects of bed net use on malaria risk, with several important studies in the 1990s.
A 2004 meta-analysis found that insecticide-treated nets reduced childhood mortality by 17%, malarial parasite prevalence by 13%, and cases of both uncomplicated and severe malaria by about 50% (compared to no nets) [@lengeler2004].
Insecticide resistance since the World Health Organization began recommending insecticide-treated nets is a big concern, but a follow-up analysis of trials found that it has yet to impact the public health benefits of bed nets [@pryce2018].

Trials have also been important in determining the economics of bed net programs.
For instance, one trial compared free net distribution versus a cost share program (where participants pay a subsidized fee for nets).
The authors of that study found that net uptake was similar between the groups, and that free free net distribution---because it was easier to access--saved more lives, and was cheaper per life saved than the cost-sharing program [@cohen2010].

There are several reasons why we might not be able to conduct a randomized trial, however, including ethics, cost, and time.
Luckily, we have substantial robust evidence in favor of bed net use, but let's consider some conditions where observational causal inference is useful in the study of bed nets and malaria prevention.

-   Imagine we are at a time prior to trials on this subject but when people had started to use bed nets for this purpose on their own: our goal may still be to conduct a randomized trial, but we can answer questions more quickly with observed data, perhaps guiding the design of trials or intermediary policy suggestions.

-   Sometimes it is also not ethical to conduct a trial.
    An interesting example of this in malaria research is a question that arose in the study of bed net effectiveness: does malaria control in early childhood result in delayed immunity to the disease, resulting in severe malaria or death later in life?
    Since we now know bed net use is very effective, *withholding* nets would be unethical.
    A recent observational study found that benefits of bed net use in childhood on all-cause mortality persist into adulthood [@mosquito].

-   We also may want to estimate a different effect or for a different population than what was studied in previous trials.
    In fact, both randomized trials and observational studies helped us better understand that insecticide-based nets actually improve malaria resistance in the entire community, not just among those who use nets, so long as net usage is high enough [@howard2000; @hawley2003].

As we'll see in chapters (TODO: precision) and (TODO: loss to follow up), the causal inference techniques that we'll discuss in this book are often very helpful even when we're able to randomize.

When we conduct an observational study, it's still helpful to think through the randomized trial we would like to conduct were it possible to do so.
The trial we're trying to emulate in this causal analysis is the *target trial.* Considering the target trial helps us make our causal question more accurate.
Let's think about the causal question posed earlier: does using a bed net (a mosquito net) reduce risk of malaria?
This is a relatively straightforward question, but it is still vague.
In conducting an analysis, we'll need to address several key questions:

-   What do we mean by "bed net"?
    There are several types of nets: untreated bed nets, insecticide-treated bed nets, and newer long-lasting insecticide-treated bed nets

-   Risk compared to what?
    Are we, for instance, comparing insecticide-treated bed nets to *no* net?
    Untreated nets?
    Or are we comparing a new type of net, like long-lasting insecticide-treated bed nets, to nets that are already in use?

-   Risk as defined by what?
    Whether or not a person contracted malaria?
    Whether a person died of malaria?

-   Risk among whom?
    What is the population we're trying to apply this knowledge to?
    Who is it practical to include in our study?
    Who might we need to exclude?

We're going to use simulated data to answer a more specific question: does the use of insecticide-treated bed nets decrease the risk of contracting malaria?
In this particular data, [simulated by Dr. Andrew Heiss](https://evalsp21.classes.andrewheiss.com/example/matching-ipw/#program-background):

> researchers are interested in whether using mosquito nets decreases an individual's risk of contracting malaria.
> They have collected data from 1,752 households in an unnamed country and have variables related to environmental factors, individual health, and household characteristics.
> The data is **not experimental**---researchers have no control over who uses mosquito nets, and individual households make their own choices over whether to apply for free nets or buy their own nets, as well as whether they use the nets if they have them.

Because we're using simulated data, we'll have direct access to a variable that measures likelihood of contracting malaria, something we wouldn't likely have in real life.
We'll stick with this measure because we know the real effect size.
We'll use simulated data, `net_data`, from the {causalworkshop} package (TODO: move this to causaldata?), which includes ten variables:

`id`

:   an ID variable

`net` and `net_num`

:   a binary variable indicating if the participant used a net (1) or didn't use a net (0)

`malaria_risk`

:   a risk of malaria scale ranging from 0-100

`income`

:   weekly income, measured in dollars

`health`

:   a health score scale ranging from 0--100

`household`

:   number of people living in the household

`eligible`

:   a binary variable indicating if the household is eligible for the free net program.

`temperature`

:   the average temperature at night, in Celsius

`resistance`

:   Insecticide resistance of local mosquitoes.
    This is measured on a scale of 0--100, with higher values indicating higher resistance.

The distribution of malaria risk appears to be quite different by net usage.

```{r}
library(tidyverse)
library(causalworkshop)
library(ggokabeito)

net_data |> 
  ggplot(aes(malaria_risk, fill = net)) +
  geom_density(color = NA) + 
  scale_fill_okabe_ito(alpha = .8)
```

```{r, echo=FALSE}
means <- net_data |>
  group_by(net) |> 
  summarize(malaria_risk = mean(malaria_risk)) |> 
  pull(malaria_risk)
```

The mean difference in malaria risk is about `r round(means[[1]] - means[[2]], digits = 1)`, suggesting net use might be protective against malaria.

```{r}
net_data |>
  group_by(net) |> 
  summarize(malaria_risk = mean(malaria_risk))
```

And that's what we see with simple linear regression, as well.

```{r}
library(broom)
net_data |> 
  lm(malaria_risk ~ net, data = _) |> 
  tidy()
```

The problem here is that other factors may be responsible for the effect we're seeing.
In this example, we'll focus on confounding: a common cause of net usage and malaria will bias the effect we see unless we account for it some way.
One of the best ways to determine which variables we need to account for is to use a causal diagram.
These diagrams, also called causal directed acyclic graphs (DAGs), visualize the assumptions that we're making about the causal relationships between the exposure, outcome, and other variables we think might be related.

Here's the DAG that we're proposing for this question.

```{r, echo = FALSE, fig.width=7}
library(ggdag, warn.conflicts = FALSE)
mosquito_dag <- dagify(
  malaria_risk ~ net + income + health + temperature + resistance,
  net ~ income + health + temperature + eligible + household,
  eligible ~ income + household,
  health ~ income,
  exposure = "net",
  outcome = "malaria_risk",
  coords = list(
    x = c(
      malaria_risk = 7, 
      net = 3, 
      income = 4, 
      health = 5,
      temperature = 6, 
      resistance = 8.5, 
      eligible = 2, 
      household = 1
    ),
    y = c(
      malaria_risk = 2,
      net = 2, 
      income = 3, 
      health = 1,
      temperature = 3, 
      resistance = 2, 
      eligible = 3, 
      household = 2
    )
  ),
  labels = c(
    malaria_risk = "Risk of malaria", 
    net = "Mosquito net", 
    income = "Income",
    health = "Health", 
    temperature = "Nighttime temperatures",
    resistance = "Insecticide resistance",
    eligible = "Eligible for program", 
    household = "Number in household"
  )
) 

mosquito_dag |> 
  tidy_dagitty() |> 
  node_status() |> 
  ggplot(
    aes(x, y, xend = xend, yend = yend, color = status)
  ) +
  geom_dag_edges() +
  geom_dag_point() +
  geom_dag_label_repel() +
  scale_color_okabe_ito(na.value = "grey90") +
  theme_dag() +
  theme(legend.position = "none") + 
  coord_cartesian(clip = "off")
```

(We'll explore how to create and analyze DAGs in R in Chapter TODO).

In DAGs, each point represents a variable, and each arrow represents a cause.
In other words, this diagram declares what we think the causal relationships are between these variables.
We're saying that we believe:

-   Malaria risk is causally impacted by net usage, income, health, temperature, and insecticide resistance.
-   Net usage is causally impacted by income, health, temperature, eligibility for the free net program, and the number of people in a household.
-   Eligibility for the free net programs is determined by income and the number of people in a household.
-   Health is causally impacted by income.

You may agree or disagree with some of these assertions.
That's a good thing!
Laying bare our assumptions allows us to consider the scientific credibility of our analysis.
Another benefit of using DAGs is that, thanks to the mathematics behind them, we can determine exactly the subset of variables we need to account for if we assume this DAG is true.

::: callout-tip
## Assembling DAGs

In this exercise, we're providing you a reasonable DAG based on our knowledge of how the data we're generated.
In real life, setting up a DAG is a challenge requiring deep thought, domain expertise, and (often) collaboration between several experts.
:::

The chief problem we're dealing with is that, when we analyze the data we're working with, we not only see the impact of net usage on malaria risk, but of all these other relationships, as well.
In DAG terminology, we have more than one open causal pathway.
If this DAG is right, in fact, we have *eight* causal pathways: the path between net usage and malaria risk and seven other *confounding* pathways.

```{r, echo = FALSE, fig.width=14}
ggdag_paths(
  mosquito_dag, text = FALSE, shadow = TRUE
) +
  theme_dag() +
  theme(
    legend.position = "none", 
    strip.text = element_blank()
  ) + 
  coord_cartesian(clip = "off") +
  scale_color_okabe_ito(na.value = "grey90", order = 3) +
  scale_edge_color_okabe_ito(na.value = "grey90", order = 3)
```

When we calculate a naive linear regression that only includes net usage and malaria risk, the effect we see is incorrect because it is distorted by the seven other confounding pathways.
In DAG terminology, we need to *block* these open pathways that are distorting the causal estimate we're after.
(We can block paths through a number of techniques, including stratification, matching, weighting, and more. We'll see several techniques throughout the book.) Luckily, by specifying a DAG, we can determine exactly the set of variables we need to control for to do this.
For this DAG, we need to control for three variables: `r glue::glue_collapse(as.list(dagitty::adjustmentSets(mosquito_dag))[[1]], sep = ", ", last = ", and ")`.
These three variables are a *minimal adjustment set*, the minimum set (or sets) of variables that you need to block all confounding pathways.
We'll discuss adjustment sets further in Chapter \@ref(TODO)

To control for these variables, we'll use a technique called Inverse Probability Weighting (IPW), which we'll discuss in detail in Chapters \@ref(TODO).
Briefly, we'll use logistic regression to predict the probability of treatment---the propensity score.
Then, we'll calculate inverse probability weights to apply to the linear regression model we fit above.
The propensity score model includes the exposure---net use---as the dependent variable and the minimal adjustment set as the independent variables.

::: callout-tip
## Modeling the functional form

Generally speaking, we want to lean on domain expertise and good modeling practices to fit the propensity score model.
For instance, we may want to allow continuous confounders to be non-linear using splines, or we may want to add important interactions between confounders.
Because these data are simulated, we know that we don't need these extra parameters (so we'll skip them), but in practice, you often do.
We'll discuss this more in Chapter \@ref(TODO)
:::

The propensity score model is a logistic regression model with the formula `net ~ income + health + temperature`, which predicts the probability of bed net usage based on the .

```{r}
propensity_model <- glm(
  net ~ income + health + temperature, 
  data = net_data, 
  family = binomial()
)

# the first six propensity scores
head(predict(propensity_model, type = "response"))
```

We can use propensity scores to control for confounding in a variety of ways.
In this example, we'll focus on weighting.
In particular, we'll compute the inverse probability weight for the *average treatment effect* (ATE).
The ATE represents a very specific causal question: what if *everyone* in the study used bed nets vs. what if *no one* in the study used bed nets?

To calculate the ATE, we'll use the broom and propensity packages.
broom's `augment()` function extracts prediction-related information from the model and joins it to the data.
propensity's `wt_ate()` function calculates the inverse probability weight given the propensity score and exposure.

For inverse probability weighting, the ATE weight is the probability of receiving the treatment you actually received.
In other words, if you used a bed net, the ATE weight is the probability that you used a net, and if you did *not* use a net, it is the probability that you did not use a net.

```{r}
library(broom)
library(propensity)
net_data_wts <- propensity_model |> 
  augment(type.predict = "response") |> 
  # .fitted is the value predicted by the model 
  # for a given observation
  mutate(wts = wt_ate(.fitted, net))

net_data_wts |> 
  select(net, .fitted, wts) |> 
  head()
```

`wts` represents the amount that each observation will be up-weighted or down-weighted in the outcome model that we will soon fit.
For instance, the first household used a bed net and had a predicted probability of `r round(net_data_wts$.fitted[[1]], digits = 2)`.
That's a pretty low probability considering they did, in fact, use a net, so their weight is higher at `r round(net_data_wts$wts[[1]], digits = 2)`.
In other words, this household will be upweighted almost 3 times compared to the naive linear model we fit above.
The second household did *not* use a bed net; they're predicted probability of net use was `r round(net_data_wts$.fitted[[2]], digits = 2)` (or put differently, a predicted probability of *not* using a net of `r 1 - round(net_data_wts$.fitted[[2]], digits = 2)`).
That's more in line with they're observed value of `net`, but there's still some predicted probability of using a net, so their weight is `r round(net_data_wts$wts[[2]], digits = 2)`.

The goal of propensity score weighting is to weight the population of observations such that the distribution of confounders is balanced between the exposure groups.
Here's the distribution of the propensity score by group, created by `geom_mirror_histogram()` from the halfmoon package for assessing balance in propensity score models:

```{r}
library(halfmoon)
ggplot(net_data_wts, aes(.fitted)) + 
  geom_mirror_histogram(
    aes(fill = net),
    bins = 50
  ) + 
  # TODO: shouldn't need this
  ggokabeito::scale_fill_okabe_ito()
```

The weighted propensity score creates a pseudo-population where the distributions are much more similar:

```{r}
ggplot(net_data_wts, aes(.fitted)) + 
  geom_mirror_histogram(
    aes(group = net),
    bins = 50
  ) + 
  geom_mirror_histogram(
    aes(fill = net, weight = wts),
    bins = 50,
    alpha = .5
  ) + 
  # TODO: shouldn't need this
  ggokabeito::scale_fill_okabe_ito() +
  scale_y_continuous(labels = abs)
```

In this example, the unweighted distributions is not awful, but the weighted distributions are much more similar.

::: callout-tip
## Unmeasured confounding

Propensity score weighting and most other causal inference techniques only help with *observed* confounders---ones that we model correctly, at that.
Unfortunately, we still may have unmeasured confounding, which we'll discuss below.

Randomization is one causal inference technique that *does* deal with unmeasured confounding, one of the reasons it is so powerful.
:::

We might also want to know how well balanced the groups are by confounder.
One way to do this is to calculate the standardized mean differences (SMDs) for each confounder with and without weights.
We'll calculate the SMDs with `tidy_smd()` then plot them with `geom_love()`.

```{r}
plot_df <- tidy_smd(
  net_data_wts,
  c(income, health, temperature),
  .group = net,
  .wts = wts
)

ggplot(
  plot_df,
  aes(
    x = abs(smd),
    y = variable,
    group = weights,
    color = weights
  )
) +
  geom_love()
```

A common guideline is that balanced confounders should have an SMD of less than 0.1 on the absolute scale.
This is just a rule of thumb, but if we follow it, then these variables are well-balanced after weighting (and unbalanced before weighting).

Before we apply the weights to the outcome model, let's check their overall distribution for extreme weights.
Extreme weights can destabilize the variance in the outcome model, so we want to be aware of it.
We'll also discuss several other types of weights that are less prone to this issue in Chapter \@ref(TODO).

```{r}
net_data_wts |> 
  ggplot(aes(wts)) + 
  geom_density(fill = "#0072B2", color = NA)
```

The weights look pretty reasonable.
If we saw extreme weights, we might try trimming or stabilizing them, which we'll discuss in Chapter \@ref(TODO).
It doesn't look like we need to do that here, however.

TODO: sensitivity analysis of sickle cell and ethnicity as a confounder.
Add second dataset where these ARE confounders.
Show tipr first with data where this is true then show what it is with lm() etc.
See Lucy's blog post.

TODO: Maybe use sickle cell as example of precision variable

```{r}
# real dag:
mosquito_dag_full <- dagify(
  malaria_risk ~ net + income + health + temperature + insecticide_resistance + genetic_resistance,
  net ~ income + health + temperature + eligible + household + genetic_resistance,
  eligible ~ income + household,
  health ~ income,
  exposure = "net",
  outcome = "malaria_risk",
  coords = list(x = c(malaria_risk = 7, net = 3, income = 4, health = 5,
                      temperature = 6, insecticide_resistance = 8.5, eligible = 2, household = 1, genetic_resistance = 8.5),
                y = c(malaria_risk = 2, net = 2, income = 3, health = 1,
                      temperature = 3, insecticide_resistance = 2, eligible = 3, household = 2, genetic_resistance = 1)),
  labels = c(malaria_risk = "Risk of malaria", net = "Mosquito net", income = "Income",
             health = "Health", temperature = "Nighttime temperatures",
             insecticide_resistance = "Insecticide resistance",
             eligible = "Eligible for program", household = "Number in household",
             genetic_resistance = "Malaria resistance"
             )
)

ggdag_status(mosquito_dag, use_labels = "label", text = FALSE) +
  guides(fill = "none", color = "none") +  # Disable the legend
  theme_dag()

dagitty::adjustmentSets(mosquito_dag_full)
```
